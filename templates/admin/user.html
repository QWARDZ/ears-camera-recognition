<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Users</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.21/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin/user.css') }}">
</head>
<body>

    {% include 'layout/admin_nav.html' %}

    <div class="main-container">
        <div class="header-section">
            <h1>Manage Users</h1>
            <button class="btn btn-primary" onclick="showRoleSelection()">+ Add New User</button>
        </div>

        <div class="table-container">
            <table id="userTable" class="display">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Profile</th>
                        <th>Full Name</th>
                        <th>Username</th>
                        <th>Password</th>
                        <th>Role</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr>
                        <td>{{ loop.index }}</td>
                        <td>
                            {% if user[7] %}
                                <img src="{{ url_for('static', filename='uploads/' ~ user[7]) }}" alt="Profile Picture" style="width: 40px; height: 40px; border-radius: 50%;">
                            {% else %}
                                <img src="{{ url_for('static', filename='uploads/default_profile.png') }}" alt="Default Picture" style="width: 40px; height: 40px; border-radius: 50%;">
                            {% endif %}
                        </td>
                        <td>{{ user[1] }}</td>
                        <td>{{ user[2] }}</td>
                        <td>{{ user[4] }}</td>
                        <td>{{ user[3] }}</td>
                
                        
                        <td>
                            <button class="btn btn-primary" 
                            onclick="editUser('{{ user[0] }}', '{{ user[1] }}', '{{ user[2] }}', '{{ user[2] }}', '{{ user[4] }}', '{{ user[3] }}', '{{ user[7] }}', '{{ user[5] }}', '{{ user[6] }}')">Edit</button>                        
                            <form method="POST" action="/admin/user/delete/{{ user[0] }}" style="display:inline;">
                                <button type="submit" class="btn btn-danger">Delete</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                
            </table>
        </div>
    </div>

    <!-- Modal for Role Selection -->
    <div id="roleSelectionModal" class="modal">
        <div class="modal-content">
            <h2>Select Role</h2>
            <div class="role-selection">
                <button class="btn btn-primary" onclick="showAddUserForm('admin')">Add New Admin</button>
                <button class="btn btn-primary" onclick="showAddUserForm('employee')">Add New Employee</button>
                <button class="btn cancel-btn" onclick="closeModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Modal for Adding/Editing User -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <h2>User Master Data</h2>
            <form method="POST" action="/admin/user">
                <input type="hidden" id="user_id" name="user_id">
                <input type="hidden" id="role" name="role"> <!-- Role field for backend processing -->

                <!-- Employee Information -->
                <div class="form-group">
                    <label for="first_name">First Name</label>
                    <input type="text" id="first_name" name="first_name" required>
                </div>
                <div class="form-group">
                    <label for="last_name">Last Name</label>
                    <input type="text" id="last_name" name="last_name" required>
                </div>

                <div class="form-group" id="gender_field">
                    <label for="gender">Gender</label>
                    <select id="gender" name="gender">
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <div class="form-group" id="department_field">
                    <label for="department">Department</label>
                    <select id="department" name="department">
                        {% for department in departments %}
                            <option value="{{ department[0] }}">{{ department[1] }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group" id="shift_field">
                    <label for="shift">Shift</label>
                    <select id="shift" name="shift">
                        {% for shift in shifts %}
                            <option value="{{ shift[0] }}">{{ shift[1] }} - {{ shift[2] }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" name="username" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="text" id="password" name="password" required>
                </div>

                <button type="submit" class="btn save-btn">Save</button>
                <button type="button" class="btn cancel-btn" onclick="closeModal()">Cancel</button>
            </form>            
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.min.js"></script>
    <script>

        // Sidebar Toggle
        const sidebar = document.querySelector('.sidebar');
        const toggleBtn = document.querySelector('.toggle-btn');
        const mainContainer = document.querySelector('.main-container');

        toggleBtn.addEventListener('click', () => {
            sidebar.classList.toggle('active');
            if (sidebar.classList.contains('active')) {
                mainContainer.style.marginLeft = '260px'; /* Adjust margin when sidebar expands */
            } else {
                mainContainer.style.marginLeft = '80px'; /* Default margin */
            }
        });


        $(document).ready(function() {
            $('#userTable').DataTable();

            var roleSelectionModal = document.getElementById("roleSelectionModal");
            var userModal = document.getElementById("userModal");
            var userIdInput = document.getElementById("user_id");
            var firstNameInput = document.getElementById("first_name");
            var lastNameInput = document.getElementById("last_name");
            var departmentInput = document.getElementById("department");
            var shiftInput = document.getElementById("shift");
            var genderInput = document.getElementById("gender");
            var usernameInput = document.getElementById("username");
            var roleInput = document.getElementById("role");
            var passwordInput = document.getElementById("password");

            window.showRoleSelection = function() {
                roleSelectionModal.style.display = "block";
            };

            window.showAddUserForm = function(role) {
                userIdInput.value = '';
                firstNameInput.value = '';
                lastNameInput.value = '';
                departmentInput.value = '';
                shiftInput.value = '';
                genderInput.value = 'Male';
                usernameInput.value = '';
                roleInput.value = role;
                passwordInput.value = '';
                toggleFormFields(role);
                userModal.style.display = "block";
                roleSelectionModal.style.display = "none";
            };

            window.editUser = function(id, first_name, last_name, username, password, role, gender, department, shift) {
            userIdInput.value = id;
            firstNameInput.value = first_name;
            lastNameInput.value = last_name;
            departmentInput.value = department || '';
            shiftInput.value = shift || '';
            genderInput.value = gender || 'Male';
            usernameInput.value = username;
            roleInput.value = role;
            passwordInput.value = password;
            toggleFormFields(role); // This will hide/show fields based on the role
            userModal.style.display = "block";
        };


            window.closeModal = function() {
                userModal.style.display = "none";
                roleSelectionModal.style.display = "none";
            };

            window.onclick = function(event) {
                if (event.target == userModal || event.target == roleSelectionModal) {
                    userModal.style.display = "none";
                    roleSelectionModal.style.display = "none";
                }
            };

            // Toggle form fields based on role selection
            function toggleFormFields(role) {
            if (role === 'admin') {
                document.getElementById("gender_field").classList.add('hidden');
                document.getElementById("department_field").classList.add('hidden');
                document.getElementById("shift_field").classList.add('hidden');
            } else {
                document.getElementById("gender_field").classList.remove('hidden');
                document.getElementById("department_field").classList.remove('hidden');
                document.getElementById("shift_field").classList.remove('hidden');
            }
        }

        });


// JavaScript function to format time from 24-hour to 12-hour format with AM/PM
function formatTime(time) {
    if (!time || time === '-') {
        return '-';  // Handle cases where the time is not available
    }
    
    let [hours, minutes] = time.split(':');
    let ampm = 'AM';
    hours = parseInt(hours);

    if (hours >= 12) {
        ampm = 'PM';
        if (hours > 12) hours -= 12;
    } else if (hours === 0) {
        hours = 12;
    }

    return `${hours}:${minutes} ${ampm}`;
}

    </script>

</body>
</html>